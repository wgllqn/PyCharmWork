# SQL Agent 项目完整分析文档

## 一、项目概述

SQL Agent 是一个基于 AI 的智能数据分析平台，允许用户通过自然语言查询和分析结构化数据。该项目采用前后端分离架构，整合了 LangChain、OpenAI、FastAPI 和 React 等现代技术栈。

### 核心功能

- 📊 **自然语言数据查询** - 使用 LangChain SQL Agent 将自然语言转换为 SQL 查询
- 📁 **文件上传支持** - 支持 CSV/Excel 文件上传，自动创建 SQLite 数据库
- 📈 **数据可视化** - 提供 7 种图表类型（柱状图、折线图、饼图等）
- 💬 **对话式分析** - 支持会话记忆的智能数据分析对话
- 🗄️ **多数据源支持** - 同时支持上传文件和数据库表查询

---

## 二、项目目录结构

```
04_SqlAgent/
├── backend/                    # Python FastAPI 后端
│   ├── app/                   # 主应用模块
│   │   ├── __init__.py
│   │   ├── main.py            # FastAPI 主应用和 API 路由
│   │   ├── config.py          # 配置管理 (Pydantic Settings)
│   │   ├── models.py          # Pydantic 数据模型定义
│   │   ├── sql_agent.py       # LangChain SQL Agent 核心实现
│   │   └── visualization.py   # 数据可视化模块 (Plotly/Matplotlib)
│   │
│   ├── utils/                 # 工具模块
│   │   ├── __init__.py
│   │   └── file_processor.py  # CSV/Excel 文件处理工具
│   │
│   ├── data/                  # 数据存储目录
│   │   ├── sales_data.db      # SQLite 数据库 (5.8MB)
│   │   └── 电子产品销售数据.csv  # 原始销售数据 (5.2MB)
│   │
│   ├── models/                # 保留目录（暂无内容）
│   │
│   ├── .env                   # 环境变量配置
│   ├── requirements.txt       # Python 依赖
│   ├── run.py                 # 启动脚本
│   ├── api_with_db.py         # 带数据库支持的 API
│   ├── data_manager.py        # 数据管理器
│   ├── init_database.py       # 数据库初始化脚本
│   ├── test_api.py            # API 测试脚本
│   ├── test_client.py         # 客户端测试
│   ├── test_complete_api.py   # 完整 API 测试
│   ├── start_server.sh        # Shell 启动脚本
│   └── README.md              # 后端文档
│
└── frontend/                   # React TypeScript 前端
    ├── src/
    │   ├── main.tsx           # React 应用入口
    │   ├── App.tsx            # 主应用组件
    │   ├── NewApp.tsx         # 新版应用
    │   ├── components/        # 可复用组件库
    │   ├── services/          # API 服务层
    │   ├── styles/            # 样式文件
    │   └── guidelines/        # 设计指南
    │
    ├── index.html
    ├── package.json           # Node.js 依赖
    ├── tsconfig.json          # TypeScript 配置
    ├── vite.config.ts         # Vite 构建配置
    ├── tailwind.config.js     # Tailwind CSS 配置
    ├── postcss.config.js      # PostCSS 配置
    └── node_modules/          # NPM 包（已安装）
```

---

## 三、技术栈详解

### 3.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **FastAPI** | >= 0.115.0 | 高性能 Web 框架，提供异步 API |
| **LangChain** | >= 0.3.0 | LLM 应用框架，SQL Agent 实现 |
| **LangChain OpenAI** | >= 0.2.0 | OpenAI 集成 |
| **SQLAlchemy** | >= 2.0.30 | ORM 和数据库连接 |
| **Pandas** | >= 2.2.0 | 数据处理和分析 |
| **SQLite** | 内置 | 轻量级关系型数据库 |
| **Plotly** | >= 5.24.0 | 交互式数据可视化 |
| **Matplotlib** | >= 3.9.0 | 静态图表生成 |
| **Seaborn** | >= 0.13.0 | 高级统计图表 |
| **Pydantic** | >= 2.10.0 | 数据验证和设置管理 |
| **Python-dotenv** | >= 1.0.1 | 环境变量管理 |
| **Uvicorn** | >= 0.32.0 | ASGI 服务器 |

### 3.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **React** | ^18.3.1 | 用户界面框架 |
| **TypeScript** | ^5.2.2 | 类型安全的 JavaScript 超集 |
| **Vite** | ^6.3.5 | 快速的前端构建工具 |
| **Tailwind CSS** | ^3.4.0 | 实用优先的 CSS 框架 |
| **Radix UI** | 最新 | 无头 UI 组件库 |
| **Recharts** | ^2.15.2 | React 图表库 |
| **Axios** | ^1.13.1 | HTTP 客户端 |
| **React Hook Form** | ^7.55.0 | 高性能表单管理 |
| **React Markdown** | ^10.1.0 | Markdown 渲染器 |

---

## 四、核心功能模块

### 4.1 SQL Agent 管理器 (`app/sql_agent.py`)

#### 核心类：`SQLAgentManager`

**主要功能：**
- 从 CSV/Excel 文件创建 SQLite 数据库
- 初始化 OpenAI LLM（支持自定义 base_url）
- 创建 LangChain SQL Agent
- 自然语言查询转换为 SQL
- 执行 SQL 查询并返回结构化结果

**关键方法：**

```python
class SQLAgentManager:
    def __init__(self, openai_api_key, openai_base_url, model):
        """初始化 SQL Agent 管理器"""

    def create_database_from_file(self, file_content, file_type, table_name):
        """从文件创建 SQLite 数据库"""

    def create_sql_agent(self, system_prompt):
        """创建 LangChain SQL Agent"""

    def query_data(self, question) -> Dict:
        """执行自然语言查询
        返回: {
            success: bool,
            answer: str,
            sql: str,
            reasoning: List[str],
            data: List[Dict]
        }
        """

    def execute_custom_sql(self, sql_query):
        """执行自定义 SQL 查询"""

    def get_table_schema(self):
        """获取数据库表结构"""

    def cleanup(self):
        """清理临时文件和资源"""
```

**系统提示词特性：**
- 强制要求先调用 `sql_db_list_tables` 获取真实表名
- 自动处理 LIMIT 子句（根据用户指定数量）
- 支持四步执行流程：查表 → 查架构 → 生成 SQL → 执行
- 生成 Markdown 格式的数据分析报告

---

### 4.2 FastAPI 主应用 (`app/main.py`)

#### API 端点汇总

| 方法 | 路由 | 功能描述 |
|------|------|---------|
| GET | `/` | API 文档首页（HTML） |
| GET | `/docs` | Swagger 交互式 API 文档 |
| GET | `/health` | 健康检查端点 |
| GET | `/datasources` | 获取所有数据源（数据库表 + 上传文件） |
| GET | `/files` | 列出所有已上传文件 |
| DELETE | `/files/{file_id}` | 删除文件及其关联 Agent |
| POST | `/upload` | 上传 CSV/Excel 文件 |
| POST | `/query` | 自然语言查询（支持 file_id 或 table_name） |
| POST | `/visualize` | 创建数据可视化图表 |
| POST | `/chat` | 对话式数据分析（支持会话记忆） |

#### 核心特性

- **CORS 中间件** - 允许跨域请求
- **应用生命周期管理** - startup/shutdown 事件处理
- **全局状态管理** - `file_store`、`chat_sessions`、`sql_agents`
- **错误处理和日志** - 完整的异常处理和日志记录

---

### 4.3 数据可视化模块 (`app/visualization.py`)

#### 支持的图表类型

| 图表类型 | 英文名称 | 适用场景 |
|---------|---------|---------|
| 柱状图 | `bar` | 分类数据对比，支持分组 |
| 折线图 | `line` | 时间序列趋势，支持多系列 |
| 饼图 | `pie` | 占比分析 |
| 散点图 | `scatter` | 相关性分析 |
| 直方图 | `histogram` | 数据分布 |
| 箱线图 | `box` | 统计分布和异常值 |
| 热力图 | `heatmap` | 相关性矩阵 |

#### 功能特性

- 使用 Plotly 生成交互式图表（返回 HTML/JSON）
- 自动选择数值列进行可视化
- 支持中文字体显示
- 可自定义图表标题、轴标签等

---

### 4.4 文件处理工具 (`utils/file_processor.py`)

#### 核心类：`FileProcessor`

**静态方法：**

```python
class FileProcessor:
    @staticmethod
    def get_file_headers(file_content, file_type):
        """提取文件表头和列信息
        返回: (headers, column_info, total_columns, estimated_rows)
        """

    @staticmethod
    def _estimate_rows(file_content, file_type):
        """估算文件行数"""

    @staticmethod
    def query_data(file_content, file_type, query, limit):
        """查询文件数据（用于预览）"""
```

**支持的文件格式：**
- CSV（`.csv`）
- Excel（`.xlsx`, `.xls`）

---

### 4.5 数据管理器 (`data_manager.py`)

**功能：**
- 加载真实的电子产品销售数据 CSV
- 创建模拟 ERP 数据（产品、库存、订单）
- 创建销售分析数据
- 生成 SQLite 数据库

**包含的数据表：**
- `sales_data` - 电子产品销售记录（来自 CSV，5000+ 条）
- `erp_products` - ERP 产品表（10 种产品）
- 其他分析表

**数据字段示例：**
- 产品编号、产品名称、分类
- 销售数量、销售额
- 客户评分、评论数
- 地区、时间戳等

---

## 五、数据模型定义 (`app/models.py`)

### 5.1 文件上传响应

```python
class FileUploadResponse(BaseModel):
    success: bool
    file_id: str                    # 唯一文件标识符
    headers: List[str]              # 列名列表
    column_info: List[Dict]         # 列详细信息
    total_columns: int              # 总列数
    estimated_rows: int             # 估算行数
```

### 5.2 查询请求/响应

```python
class QueryRequest(BaseModel):
    query: str                      # 自然语言查询
    file_id: Optional[str]          # CSV 文件 ID
    table_name: Optional[str]       # 数据库表名
    limit: Optional[int] = 100      # 返回行数限制

class QueryResponse(BaseModel):
    success: bool
    answer: str                     # 分析答案（Markdown 格式）
    sql: str                        # 生成的 SQL 查询
    reasoning: List[str]            # 推理步骤
    data: List[Dict]                # 查询结果数据
    columns: List[str]              # 列名
    total_rows: int                 # 总行数
    returned_rows: int              # 返回行数
```

### 5.3 聊天会话

```python
class ChatRequest(BaseModel):
    message: str                    # 用户消息
    session_id: Optional[str]       # 会话 ID（保持上下文）
    file_id: Optional[str]          # 关联的文件 ID

class ChatResponse(BaseModel):
    success: bool
    message: str                    # AI 回复
    session_id: str                 # 会话 ID
    data: Optional[List[Dict]]      # 相关数据（可选）
```

### 5.4 可视化请求

```python
class ChartType(str, Enum):
    bar = "bar"
    line = "line"
    pie = "pie"
    scatter = "scatter"
    histogram = "histogram"
    box = "box"
    heatmap = "heatmap"

class VisualizationRequest(BaseModel):
    file_id: str                    # 文件 ID
    chart_type: ChartType           # 图表类型
    x_column: Optional[str]         # X 轴列名
    y_column: Optional[str]         # Y 轴列名
    group_by: Optional[str]         # 分组列
    title: Optional[str]            # 图表标题
    limit: int = 100                # 数据点限制
```

---

## 六、配置文件详解

### 6.1 环境变量配置 (`.env`)

```env
# ===== API 密钥配置 =====
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx    # OpenAI API 密钥（必需）
OPENAI_BASE_URL=https://ai.dv1          # 自定义 API 基础 URL（可选）
ANTHROPIC_API_KEY=your_key_here         # Anthropic API 密钥（可选）

# ===== LangSmith 跟踪配置 =====
LANGCHAIN_TRACING_V2=true               # 启用 LangSmith 跟踪
LANGCHAIN_API_KEY=your_langsmith_key    # LangSmith API 密钥
LANGCHAIN_PROJECT=sql-agent-project     # 项目名称

# ===== 数据库配置 =====
DATABASE_URL=sqlite:///./data/sql_agent.db

# ===== FastAPI 服务配置 =====
HOST=0.0.0.0                            # 监听地址
PORT=8000                               # 监听端口
DEBUG=true                              # 调试模式

# ===== 文件上传配置 =====
MAX_FILE_SIZE=100MB                     # 最大文件大小
UPLOAD_DIR=./data/uploads               # 上传目录

# ===== 可视化输出配置 =====
VIS_OUTPUT_DIR=./data/visualizations    # 图表保存目录
```

### 6.2 Python 依赖 (`requirements.txt`)

```txt
# LangChain 核心
langchain>=0.3.0                        # LLM 应用框架
langchain-openai>=0.2.0                 # OpenAI 集成
langchain-community>=0.3.0              # 社区工具包
langchain-experimental>=0.0.7           # 实验性功能

# Web 框架
fastapi>=0.115.0                        # FastAPI 框架
uvicorn[standard]>=0.32.0               # ASGI 服务器

# 配置和验证
python-dotenv>=1.0.1                    # 环境变量加载
pydantic>=2.10.0                        # 数据验证
pydantic-settings>=2.6.0                # 设置管理

# 数据库
sqlalchemy>=2.0.30                      # ORM 和数据库工具

# 数据处理
pandas>=2.2.0                           # 数据分析
numpy>=1.26.0                           # 数值计算
openpyxl>=3.1.2                         # Excel 文件支持

# 可视化
plotly>=5.24.0                          # 交互式图表
matplotlib>=3.9.0                       # 静态图表
seaborn>=0.13.0                         # 统计图表

# 其他工具
python-multipart>=0.0.9                 # 文件上传支持
```

### 6.3 前端配置 (`package.json`)

```json
{
  "name": "sql-agent-frontend",
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "@radix-ui/react-*": "最新版本",
    "axios": "^1.13.1",
    "recharts": "^2.15.2",
    "react-hook-form": "^7.55.0",
    "react-markdown": "^10.1.0"
  },
  "devDependencies": {
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "typescript": "^5.2.2",
    "vite": "^6.3.5",
    "tailwindcss": "^3.4.0",
    "postcss": "^8.4.38",
    "autoprefixer": "^10.4.19"
  }
}
```

---

## 七、启动和运行方式

### 7.1 后端启动

#### 方式 1：使用 Python 脚本启动

```bash

cd backend
python run.py
```

#### 方式 2：使用 uvicorn 直接启动

```bash
cd backend
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 方式 3：使用 Shell 脚本启动（Linux/Mac）

```bash
cd backend
chmod +x start_server.sh
./start_server.sh
```

### 7.2 前端启动

```bash
cd frontend

# 安装依赖（首次运行）
npm install

# 开发模式启动
npm run dev

# 生产构建
npm run build

# 预览生产构建
npm run preview
```

### 7.3 完整启动流程

**首次运行：**

```bash
# 1. 安装后端依赖
cd backend
pip install -r requirements.txt

# 2. 配置环境变量
# 编辑 .env 文件，设置 OPENAI_API_KEY

# 3. 初始化数据库（可选）
python init_database.py

# 4. 启动后端
python run.py

# 5. 打开新终端，安装前端依赖
cd frontend
npm install

# 6. 启动前端
npm run dev
```

**后续运行：**

```bash
# 终端 1：启动后端
cd backend && python run.py

# 终端 2：启动前端
cd frontend && npm run dev
```

---

## 八、API 使用示例

### 8.1 上传文件

```bash
POST http://localhost:8000/upload
Content-Type: multipart/form-data

file: <binary file content>
```

**响应示例：**

```json
{
  "success": true,
  "file_id": "abc123-def456-ghi789",
  "headers": ["产品编号", "产品名称", "销售数量", "销售额"],
  "column_info": [
    {"name": "产品编号", "type": "string", "sample": "P001"},
    {"name": "销售数量", "type": "int64", "sample": 150}
  ],
  "total_columns": 8,
  "estimated_rows": 5234
}
```

### 8.2 自然语言查询

```bash
POST http://localhost:8000/query
Content-Type: application/json

{
  "query": "显示销售额最高的前10个产品",
  "file_id": "abc123-def456-ghi789",
  "limit": 10
}
```

**响应示例：**

```json
{
  "success": true,
  "answer": "根据数据分析，销售额最高的前10个产品如下：\n\n1. 产品A - 销售额：¥125,000\n2. 产品B - 销售额：¥98,500\n...",
  "sql": "SELECT 产品名称, SUM(销售额) as 总销售额 FROM sales_data GROUP BY 产品名称 ORDER BY 总销售额 DESC LIMIT 10",
  "reasoning": [
    "查询可用的表名",
    "检查 sales_data 表的结构",
    "生成 SQL 查询聚合销售额",
    "执行查询并返回结果"
  ],
  "data": [
    {"产品名称": "产品A", "总销售额": 125000},
    {"产品名称": "产品B", "总销售额": 98500}
  ],
  "columns": ["产品名称", "总销售额"],
  "total_rows": 10,
  "returned_rows": 10
}
```

### 8.3 创建可视化

```bash
POST http://localhost:8000/visualize
Content-Type: application/json

{
  "file_id": "abc123-def456-ghi789",
  "chart_type": "bar",
  "x_column": "产品名称",
  "y_column": "销售数量",
  "title": "产品销售量排名",
  "limit": 20
}
```

**响应示例：**

```json
{
  "success": true,
  "chart_html": "<div>...</div>",  // Plotly HTML
  "chart_json": {...}              // Plotly JSON
}
```

### 8.4 对话分析

```bash
POST http://localhost:8000/chat
Content-Type: application/json

{
  "message": "分析这个数据的销售趋势",
  "file_id": "abc123-def456-ghi789",
  "session_id": "session-001"
}
```

**响应示例：**

```json
{
  "success": true,
  "message": "根据数据分析，销售趋势呈现以下特点：\n1. 整体呈上升趋势\n2. 季节性波动明显\n3. 第四季度销售额最高",
  "session_id": "session-001",
  "data": [...]
}
```

### 8.5 获取数据源列表

```bash
GET http://localhost:8000/datasources
```

**响应示例：**

```json
{
  "success": true,
  "datasources": [
    {
      "type": "table",
      "name": "sales_data",
      "description": "电子产品销售数据",
      "row_count": 5234
    },
    {
      "type": "file",
      "file_id": "abc123-def456-ghi789",
      "filename": "Q1_sales.csv",
      "columns": 8,
      "rows": 1234
    }
  ]
}
```

---

## 九、关键特性总结

### 9.1 后端特性

✅ **智能数据分析**
- LangChain SQL Agent 实现自然语言转 SQL
- 支持复杂查询（JOIN、聚合、子查询等）
- 自动生成 Markdown 格式分析报告

✅ **多数据源支持**
- 支持 CSV/Excel 文件上传
- 自动创建 SQLite 数据库
- 支持查询现有数据库表

✅ **数据可视化**
- 7 种图表类型（柱状图、折线图、饼图等）
- Plotly 交互式图表
- 支持自定义样式和配置

✅ **对话式交互**
- 支持会话记忆
- 上下文理解
- 智能推荐

✅ **灵活配置**
- 支持自定义 OpenAI base URL（用于代理）
- LangSmith 集成（可选）
- 完整的日志记录

### 9.2 前端特性

✅ **现代化 UI**
- React + TypeScript 开发
- Tailwind CSS 响应式设计
- Radix UI 无头组件库

✅ **快速构建**
- Vite 构建工具
- 热模块替换（HMR）
- 优化的生产构建

✅ **丰富交互**
- Markdown 支持
- 图表交互
- 表单验证

### 9.3 数据支持

✅ **真实数据集**
- 电子产品销售数据（5000+ 条记录）
- 多维度分析（销售额、评分、分类等）
- ERP 模拟数据

---

## 十、重要配置和注意事项

### 10.1 必需配置

⚠️ **环境变量配置**

必须在 `.env` 文件中配置以下变量：

```env
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx  # 必需
```

可选配置：

```env
OPENAI_BASE_URL=https://your-proxy.com/v1  # 使用代理
LANGCHAIN_TRACING_V2=true                  # 启用跟踪
```

### 10.2 端口配置

| 服务 | 默认端口 | URL |
|------|---------|-----|
| 后端 API | 8000 | http://localhost:8000 |
| 前端应用 | 5173 | http://localhost:5173 |
| API 文档 | 8000 | http://localhost:8000/docs |

### 10.3 文件限制

- **最大文件大小**：100MB（可在 `.env` 中修改）
- **支持格式**：CSV、XLSX、XLS
- **编码**：UTF-8（推荐）

### 10.4 数据库说明

- **类型**：SQLite（轻量级，无需额外安装）
- **位置**：`backend/data/`
- **自动创建**：上传文件时自动创建临时数据库
- **持久化**：可配置持久化存储

### 10.5 常见问题

**Q1: OPENAI_API_KEY 无效怎么办？**
- 检查 `.env` 文件中的 API Key 是否正确
- 确认 API Key 有足够的配额
- 如使用代理，检查 `OPENAI_BASE_URL` 配置

**Q2: 前端无法连接后端？**
- 确认后端已启动（检查 http://localhost:8000/health）
- 检查 CORS 配置
- 查看浏览器控制台错误信息

**Q3: 文件上传失败？**
- 检查文件大小是否超过限制
- 确认文件格式是否支持（CSV/Excel）
- 查看后端日志获取详细错误

**Q4: SQL 查询错误？**
- 检查自然语言描述是否清晰
- 查看生成的 SQL 语句
- 确认数据表结构是否正确

---

## 十一、项目亮点

### 11.1 技术亮点

🌟 **AI 驱动的数据分析**
- 结合 LangChain 和 OpenAI，实现真正的自然语言数据查询
- 无需编写 SQL，降低数据分析门槛

🌟 **全栈 TypeScript**
- 后端使用 Pydantic 提供类型安全
- 前端使用 TypeScript 确保代码质量

🌟 **现代化架构**
- FastAPI 异步高性能
- React 组件化开发
- Vite 快速构建

🌟 **可扩展设计**
- 模块化代码结构
- 易于添加新的数据源
- 支持自定义图表类型

### 11.2 业务价值

💼 **降低数据分析门槛**
- 非技术人员也能进行数据查询
- 自然语言交互，无需学习 SQL

💼 **提高分析效率**
- 快速上传数据文件
- 自动生成可视化图表
- 对话式数据探索

💼 **灵活部署**
- 轻量级 SQLite 数据库
- 无需复杂的基础设施
- 支持本地和云端部署

---

## 十二、后续扩展建议

### 12.1 功能扩展

- [ ] 支持更多数据库类型（PostgreSQL、MySQL 等）
- [ ] 增加数据预处理功能（清洗、转换）
- [ ] 添加用户认证和权限管理
- [ ] 支持定时任务和报表生成
- [ ] 集成更多 AI 模型（Claude、Gemini 等）

### 12.2 性能优化

- [ ] 添加查询结果缓存
- [ ] 实现数据分页加载
- [ ] 优化大文件上传处理
- [ ] 添加 WebSocket 支持实时更新

### 12.3 用户体验

- [ ] 添加查询历史记录
- [ ] 支持导出分析报告（PDF、Excel）
- [ ] 增加数据预览功能
- [ ] 提供查询建议和自动完成

---

## 十三、总结

SQL Agent 是一个功能完善的 AI 数据分析平台，整合了现代 Web 技术栈和先进的 AI 技术。通过 LangChain 和 OpenAI 的结合，用户可以使用自然语言轻松查询和分析数据，无需编写复杂的 SQL 语句。

项目采用前后端分离架构，后端使用 FastAPI 提供高性能 API，前端使用 React + TypeScript 构建现代化用户界面。支持 CSV/Excel 文件上传、多种数据可视化、对话式分析等功能，是数据分析和商业智能领域的优秀实践案例。

---

**项目信息**

- **项目路径**：`D:\zbyWorkSpace\pyCharmWorkSpace\04_SqlAgent`
- **后端框架**：FastAPI + LangChain
- **前端框架**：React + TypeScript + Vite
- **数据库**：SQLite
- **AI 模型**：OpenAI GPT

**联系方式**

如有问题或建议，请查看项目 README 或相关文档。